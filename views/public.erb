<script src="<%= js_source(@js_host, @version, 'pusher.js') %>"></script>

<p><em>
  Using pusher-js version <%= @version %>
  <% if @version >= '1.7.0' %>
    and connecting using
    <% if @ssl %>
      WSS/HTTPS <%= link_to "[toggle ssl]", test_query_string(ssl: false) %>
    <% else %>
      WS/HTTP <%= link_to "[toggle ssl]", test_query_string(ssl: true) %>
    <% end %>
  <% end %>
</em></p>

<p>These files are included in version <%= @version %>:</p>

<% files(@version).each do |file| %>
  <li><%= link_to file, js_source(@js_host, @version, file) %></li>
<% end %>

<p>
  Connection status: <strong><span id="status">unloaded</span></strong>
  <a href="#" id="connect">Connect</a>
  <a href="#" id="disconnect">Disconnect</a>
</p>

<p><a href="/hello?env=<%= @env.name %>" class="ajax">Say hello</a></p>

<script type="text/javascript">
  $(document).ready(function() {
    $('.ajax').click(function() {
      $.post(this.href);
      return false;
    })
    
    var status = function(st) {
      $('#status').text(st);
    }

    $('#connect').click(function() {
      pusher.connect();
      return false;
    });

    $('#disconnect').click(function() {
      pusher.disconnect();
      return false;
    });

    var print_message = function(msg) {
      $('#messages').append("<li>"+msg+"</li>");
    }
    
    <% if @version < "1.5.0" %>
    WebSocket.__swfLocation = "/WebSocketMain.swf";
    <% end %>
    
    Pusher.log = function() {
      if (window.console && window.console.log.apply) {
        window.console.log.apply(window.console, arguments);
      }

      var args = Array.prototype.slice.call(arguments);
      $('#debug-console').append(args.join(' ') + "\r\n")
    };

    // Not usually required - used for debugging on multiple environments
    Pusher.host = "<%= @env[:ws_host] %>";
    Pusher.ws_port = <%= @env[:ws_port] %>;
    Pusher.wss_port = <%= @env[:wss_port] %>;
    Pusher.sockjs_host = "<%= @env[:sockjs_host] %>";
    Pusher.sockjs_http_port = <%= @env[:sockjs_http_port] %>;
    Pusher.sockjs_https_port = <%= @env[:sockjs_https_port] %>;

    // Flash fallback logging
    WEB_SOCKET_DEBUG = true;
    
    <% if @version >= '1.7.0' && @ssl %>
    pusher = new Pusher('<%= @env[:key] %>', {
      encrypted: true
    });
    channel = pusher.subscribe('channel');
    channel.bind("event", function(data) {
      print_message(data);
    });
    channel.bind('alert', function(data) {
      alert(data);
    });
    <% elsif @version >= '1.4.0' %>
    pusher = new Pusher('<%= @env[:key] %>');
    channel = pusher.subscribe('channel');
    channel.bind("event", function(data) {
      print_message(data);
    });
    channel.bind('alert', function(data) {
      alert(data);
    });
    <% else %>
    pusher = new Pusher('<%= @env[:key] %>', 'channel');
    pusher.bind("event", function(data) {
      print_message(data);
    });
    pusher.bind('alert', function(data) {
      alert(data);
    });
    <% end %>
    
    <% if @version < '1.9.0' %>
      status('connecting');

      pusher.bind("pusher:connection_established", function() {
        status('connected');
      })
      pusher.bind("connection_established", function() {
        status('connected');
      })

      pusher.bind("pusher:connection_failed", function() {
        status('disconnected')
      })
      pusher.bind("connection_failed", function() {
        status('disconnected')
      })
    <% else %>
      pusher.connection.bind('state_change', function(state) {
        status(state.current)
      })
    <% end %>
  })
</script>

<h2>Messages</h2>

<ul id="messages">
  
</ul>

<h2>Debug console</h2>

<p><small>Also logged to javascript debug console, if available.</small></p>

<pre id="debug-console"></pre>